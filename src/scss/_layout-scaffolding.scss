@use "sass:list";

@use "base/sizing";

$xs-main-margin: sizing.$margin-sm;

@function named-grid-columns($sizes, $primary) {
  @if list.length($sizes) != 6 {
    @error "expected 6 column sizes, got #{list.length($sizes)}: #{$sizes}";
  }

  @if list.length($primary) != 2 {
    @error "expected primary column indices, got #{$primary}";
  }

  $tracks: [outer-left] [] [] [] [] [] [outer-right];

  $p-start: list.nth($primary, 1);
  $p-end: list.nth($primary, 2);

  $tracks: list.set-nth(
    $tracks,
    $p-start,
    list.append(list.nth($tracks, $p-start), primary-start)
  );
  $tracks: list.set-nth(
    $tracks,
    $p-end,
    list.append(list.nth($tracks, $p-end), primary-end)
  );

  @for $i from $p-start + 1 to $p-end {
    $tracks: list.set-nth(
      $tracks,
      $i,
      list.join([primary-inner], list.nth($tracks, $i))
    );
  }

  $out: ();
  @each $pair in list.zip($tracks, $sizes) {
    $out: list.join($out, $pair, $separator: space);
  }

  $out: list.append($out, list.nth($tracks, list.length($tracks)));
  @return $out;
}

@mixin content-longform {
  .content-longform &:not(.content-longform-override--false),
  &.content-longform-override--true {
    @content;
  }
}

// The container is a top-level element wrapper within the body.
// The normalize stylesheet ensures there's no body margin.
.container {
  box-sizing: border-box;
  background: url("../buildtime-assets/img/grid-bg-line-start.svg") left
      $xs-main-margin center repeat-y,
    url("../buildtime-assets/img/grid-bg-line-end.svg") right $xs-main-margin
      center repeat-y;
  padding-top: sizing.$eighth-grid;
  min-height: 100vh;

  @media (min-width: sizing.$screen-sm-min) {
    background: url("../buildtime-assets/img/grid-bg-center-2x.svg") center
      repeat-y;
  }

  @media (min-width: sizing.$screen-md-min) {
    background: url("../buildtime-assets/img/grid-bg-hide.svg") center repeat-y,
      url("../buildtime-assets/img/grid-bg.svg") center repeat;
  }

  @media (min-width: sizing.$screen-lg-min) {
    background: url("../buildtime-assets/img/grid-bg-center-hide.svg") center
        repeat-y,
      url("../buildtime-assets/img/grid-bg-center.svg") center repeat;
  }

  @include content-longform {
    background: url("../buildtime-assets/img/grid-bg-line-hl-start.svg") left
      $xs-main-margin center repeat-y;

    @media (min-width: sizing.$screen-sm-min) {
      background: url("../buildtime-assets/img/grid-bg-center-2x-hl-start.svg")
        center repeat-y;
    }
  }
}

// Base definition for the layout grid
//
// The grid is defined with 6 columns, of which up to three columns on the
// outside may be empty.
//
// In the `xs` layout all space is allocated to a single column, with margins
// excepted. In the `sm` layout two fixed-sized columns are available. On larger
// screens, where there are at least three columns available, column to the left
// of centre is allocated for secondary content, followed by two to three
// columns for primary content. The outer tracks around the primary area are
// named `primary-start` and `primary-end`, while any tracks between primary
// columns are named `primary-inner`.
//
// Given longform content, in the `md` layout, where there are between 3 and 4
// columns available, the rightmost two complete columns, which contain the
// longform content, are centred.
.grid-base {
  display: grid;
  grid-template-columns: named-grid-columns(
    $sizes: 0 $xs-main-margin minmax(150px, auto) $xs-main-margin 0 0,
    $primary: 3 4
  );

  @media (min-width: sizing.$screen-sm-min) {
    grid-template-columns: named-grid-columns(
      $sizes: 0 1fr sizing.$grid sizing.$grid 1fr 0,
      $primary: 3 5
    );
  }

  @media (min-width: sizing.$screen-md-min) {
    grid-template-columns: named-grid-columns(
      $sizes: 1fr sizing.$grid sizing.$grid sizing.$grid 1fr 0,
      $primary: 3 5
    );

    @include content-longform {
      grid-template-columns: named-grid-columns(
        $sizes: 0 1fr sizing.$grid sizing.$grid 1fr 0,
        $primary: 3 5
      );
    }
  }

  @media (min-width: sizing.$screen-lg-min) {
    grid-template-columns: named-grid-columns(
      $sizes: 1fr sizing.$grid sizing.$grid sizing.$grid sizing.$grid 1fr,
      $primary: 3 6
    );
  }
}
